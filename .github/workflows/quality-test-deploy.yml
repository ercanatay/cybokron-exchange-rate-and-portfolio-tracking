name: Quality Test Deploy

on:
  pull_request:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: qtd-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  control:
    name: Control (PHP ${{ matrix.php-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        php-version: ['8.3', '8.4']

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          extensions: curl, dom, mbstring, json, pdo_mysql, zip
          coverage: none

      - name: PHP Syntax Check
        run: |
          set -euo pipefail
          find . -name '*.php' -type f -print0 | while IFS= read -r -d '' file; do
            php -l "$file"
          done

  test:
    name: Test (PHP ${{ matrix.php-version }})
    needs: control
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        php-version: ['8.3', '8.4']

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          extensions: curl, dom, mbstring, json, pdo_mysql, zip
          coverage: none

      - name: Run Test Suite
        run: |
          set -euo pipefail
          php tests/run.php

  migration-check:
    name: Migration SQL Check
    needs: control
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: pdo_mysql
          coverage: none

      - name: Validate migration SQL files
        run: |
          set -euo pipefail
          ERRORS=0

          echo "Checking migration SQL files..."

          for file in database/migrations/*.sql; do
            [ -f "$file" ] || continue
            basename=$(basename "$file")

            # Check file is not empty
            if [ ! -s "$file" ]; then
              echo "WARNING: Empty migration file: ${basename}"
              continue
            fi

            # Basic SQL syntax validation via PHP
            php -r "
              \$sql = file_get_contents('$file');

              // Check for common SQL syntax issues
              \$errors = [];

              // Unbalanced parentheses
              \$open = substr_count(\$sql, '(');
              \$close = substr_count(\$sql, ')');
              if (\$open !== \$close) {
                  \$errors[] = 'Unbalanced parentheses (open: ' . \$open . ', close: ' . \$close . ')';
              }

              // Unbalanced backticks
              \$backticks = substr_count(\$sql, '\`');
              if (\$backticks % 2 !== 0) {
                  \$errors[] = 'Unbalanced backticks (count: ' . \$backticks . ')';
              }

              // Unterminated strings (simple check)
              \$singles = substr_count(\$sql, \"'\");
              if (\$singles % 2 !== 0) {
                  \$errors[] = 'Possibly unterminated string literal';
              }

              if (empty(\$errors)) {
                  echo \"  [OK] ${basename}\n\";
              } else {
                  echo \"  [FAIL] ${basename}\n\";
                  foreach (\$errors as \$e) {
                      echo \"    - \$e\n\";
                  }
                  exit(1);
              }
            "

            if [ $? -ne 0 ]; then
              ERRORS=$((ERRORS + 1))
            fi
          done

          if [ "$ERRORS" -gt 0 ]; then
            echo "Migration check failed with ${ERRORS} error(s)"
            exit 1
          fi

          echo "All migration files passed syntax check."

  deploy:
    name: Deploy
    needs: [control, test, migration-check]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    uses: ./.github/workflows/deploy.yml
    secrets: inherit

  auto-remediation:
    name: Auto Remediation
    needs: [control, test, migration-check, deploy]
    if: ${{ always() && github.event_name == 'push' && github.ref == 'refs/heads/main' && (needs.control.result == 'failure' || needs.test.result == 'failure' || needs.migration-check.result == 'failure' || needs.deploy.result == 'failure') }}
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Create failure issue
        uses: actions/github-script@v7
        with:
          script: |
            const title = `CI failure on main (${context.sha.substring(0, 7)})`;
            const results = {
              control: '${{ needs.control.result }}',
              test: '${{ needs.test.result }}',
              migration_check: '${{ needs.migration-check.result }}',
              deploy: '${{ needs.deploy.result }}'
            };
            const failed = Object.entries(results)
              .filter(([_, v]) => v === 'failure')
              .map(([k, _]) => k);

            const body = [
              'Automated CI failure report.',
              '',
              `- Workflow: ${context.workflow}`,
              `- Run: https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              `- Commit: ${context.sha}`,
              `- Failed jobs: ${failed.join(', ')}`,
              '',
              'Auto-remediation checklist:',
              '1. Inspect failing job logs.',
              '2. Reproduce locally with PHP 8.3 and 8.4.',
              '3. Commit fix and verify green pipeline before deploy.'
            ].join('\n');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body
            });
