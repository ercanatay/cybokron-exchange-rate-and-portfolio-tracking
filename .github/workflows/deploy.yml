name: Deploy to Production

on:
  workflow_call:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Read version
        id: version
        run: echo "VERSION=$(cat VERSION)" >> "$GITHUB_OUTPUT"

      - name: Generate config.php
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASS: ${{ secrets.DB_PASS }}
          APP_URL: ${{ secrets.APP_URL }}
          TURNSTILE_SITE_KEY: ${{ secrets.TURNSTILE_SITE_KEY }}
          TURNSTILE_SECRET_KEY: ${{ secrets.TURNSTILE_SECRET_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          GITHUB_API_TOKEN: ${{ secrets.CYBOKRON_GITHUB_PAT }}
        run: |
          cat > config.php << 'PHPEOF'
          <?php
          define('DB_HOST', '__DB_HOST__');
          define('DB_NAME', '__DB_NAME__');
          define('DB_USER', '__DB_USER__');
          define('DB_PASS', '__DB_PASS__');
          define('DB_CHARSET', 'utf8mb4');
          define('APP_NAME', 'Cybokron Exchange Rate & Portfolio Tracking');
          define('APP_URL', '__APP_URL__');
          define('APP_TIMEZONE', 'Europe/Istanbul');
          define('APP_DEBUG', false);
          define('ENABLE_SECURITY_HEADERS', true);
          define('CSP_POLICY', "default-src 'self'; base-uri 'self'; form-action 'self'; frame-ancestors 'self'; object-src 'none'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://challenges.cloudflare.com; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self' https://cdn.jsdelivr.net; frame-src https://challenges.cloudflare.com");
          define('HSTS_MAX_AGE_SECONDS', 31536000);
          define('DEFAULT_LOCALE', 'tr');
          define('FALLBACK_LOCALE', 'en');
          define('AVAILABLE_LOCALES', ['tr', 'en', 'ar', 'de', 'fr']);
          define('GITHUB_REPO', 'ercanatay/cybokron-exchange-rate-and-portfolio-tracking');
          define('GITHUB_BRANCH', 'main');
          define('AUTO_UPDATE', false);
          define('ENFORCE_CLI_CRON', true);
          define('BACKUP_DIR', dirname(__DIR__) . '/cybokron-backups');
          define('UPDATE_REQUIRE_SIGNATURE', true);
          define('UPDATE_PACKAGE_ASSET_NAME', '');
          define('UPDATE_SIGNATURE_ASSET_NAME', 'cybokron-update.zip.sig');
          define('UPDATE_SIGNING_PUBLIC_KEY_PEM', "");
          define('UPDATE_ALLOWED_HOSTS', ['api.github.com', 'github.com', 'codeload.github.com', 'objects.githubusercontent.com']);
          define('SCRAPE_TIMEOUT', 30);
          define('SCRAPE_USER_AGENT', 'Cybokron/1.0');
          define('SCRAPE_RETRY_COUNT', 3);
          define('SCRAPE_RETRY_DELAY', 5);
          define('SCRAPE_ALLOWED_HOSTS', ['dunyakatilim.com.tr', 'www.dunyakatilim.com.tr', 'www.tcmb.gov.tr', 'tcmb.gov.tr', 'kur.doviz.com', 'doviz.com']);
          define('OPENROUTER_AI_REPAIR_ENABLED', true);
          define('OPENROUTER_API_KEY', '__OPENROUTER_API_KEY__');
          define('OPENROUTER_MODEL', 'z-ai/glm-5');
          define('OPENROUTER_API_URL', 'https://openrouter.ai/api/v1/chat/completions');
          define('OPENROUTER_ALLOWED_HOSTS', ['openrouter.ai']);
          define('OPENROUTER_MIN_EXPECTED_RATES', 8);
          define('OPENROUTER_AI_COOLDOWN_SECONDS', 21600);
          define('OPENROUTER_AI_MAX_INPUT_CHARS', 12000);
          define('OPENROUTER_AI_MAX_ROWS', 160);
          define('OPENROUTER_AI_MAX_TOKENS', 4000);
          define('OPENROUTER_AI_TIMEOUT_SECONDS', 60);
          define('SELF_HEALING_ENABLED', true);
          define('SELF_HEALING_COOLDOWN_SECONDS', 3600);
          define('SELF_HEALING_MAX_RETRIES', 2);
          define('GITHUB_API_TOKEN', '__GITHUB_API_TOKEN__');
          define('API_ALLOW_CORS', false);
          define('API_ALLOWED_ORIGINS', []);
          define('API_REQUIRE_CSRF', true);
          define('API_MAX_BODY_BYTES', 32768);
          define('API_WRITE_RATE_LIMIT', 30);
          define('API_WRITE_RATE_WINDOW_SECONDS', 60);
          define('API_READ_RATE_LIMIT', 120);
          define('API_READ_RATE_WINDOW_SECONDS', 60);
          define('AUTH_REQUIRE_PORTFOLIO', true);
          define('LOGIN_RATE_LIMIT', 5);
          define('LOGIN_RATE_WINDOW_SECONDS', 300);
          define('AUTH_BASIC_USER', 'admin');
          define('AUTH_BASIC_PASSWORD_HASH', '');
          define('TURNSTILE_ENABLED', true);
          define('TURNSTILE_SITE_KEY', '__TURNSTILE_SITE_KEY__');
          define('TURNSTILE_SECRET_KEY', '__TURNSTILE_SECRET_KEY__');
          $ACTIVE_BANKS = ['DunyaKatilim', 'TCMB', 'IsBank'];
          define('UPDATE_INTERVAL_MINUTES', 15);
          define('MARKET_OPEN_HOUR', 9);
          define('MARKET_CLOSE_HOUR', 18);
          define('MARKET_DAYS', [1, 2, 3, 4, 5]);
          define('RATE_HISTORY_RETENTION_DAYS', 365);
          define('RATE_UPDATE_WEBHOOK_URL', '');
          define('RATE_UPDATE_WEBHOOK_URLS', []);
          define('ALERT_EMAIL_FROM', 'noreply@invest.ercanatay.com');
          define('ALERT_EMAIL_TO', '');
          define('ALERT_COOLDOWN_MINUTES', 60);
          define('ALERT_TELEGRAM_BOT_TOKEN', '');
          define('ALERT_TELEGRAM_CHAT_ID', '');
          define('ALERT_WEBHOOK_URL', '');
          $DISPLAY_CURRENCIES = ['USD', 'EUR', 'GBP', 'XAU'];
          define('LOG_ENABLED', true);
          define('LOG_FILE', dirname(__DIR__) . '/cybokron-logs/cybokron.log');
          define('DB_PERSISTENT', false);
          PHPEOF

          sed -i 's/^          //' config.php
          sed -i "s|__DB_HOST__|${DB_HOST}|g" config.php
          sed -i "s|__DB_NAME__|${DB_NAME}|g" config.php
          sed -i "s|__DB_USER__|${DB_USER}|g" config.php
          sed -i "s|__DB_PASS__|${DB_PASS}|g" config.php
          sed -i "s|__APP_URL__|${APP_URL}|g" config.php
          sed -i "s|__TURNSTILE_SITE_KEY__|${TURNSTILE_SITE_KEY}|g" config.php
          sed -i "s|__TURNSTILE_SECRET_KEY__|${TURNSTILE_SECRET_KEY}|g" config.php
          sed -i "s|__OPENROUTER_API_KEY__|${OPENROUTER_API_KEY}|g" config.php
          sed -i "s|__GITHUB_API_TOKEN__|${GITHUB_API_TOKEN}|g" config.php

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY_B64 }}" | base64 -d > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: Backup current deployment
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} bash -s << BACKUP_EOF
          set -e
          mkdir -p ~/cybokron-backups

          # Create backup of current deployment (exclude logs and backups)
          if [ -f ~/public_html/index.php ]; then
            echo "Creating backup: deploy-${TIMESTAMP}.tar.gz"
            cd ~/public_html
            tar czf ~/cybokron-backups/deploy-${TIMESTAMP}.tar.gz \
              --exclude='.well-known' \
              --exclude='cgi-bin' \
              . 2>/dev/null || true
            echo "Backup created successfully"
          else
            echo "No existing deployment to backup (first deploy?)"
          fi

          # Keep only last 3 backups
          cd ~/cybokron-backups
          ls -1t deploy-*.tar.gz 2>/dev/null | tail -n +4 | xargs -r rm -f
          echo "Backup cleanup done. Current backups:"
          ls -lh deploy-*.tar.gz 2>/dev/null || echo "  (none)"
          BACKUP_EOF

      - name: Deploy files
        run: |
          rsync -rlgoDzvc --delete \
            --exclude='.git/' \
            --exclude='.github/' \
            --exclude='.well-known/' \
            --exclude='cgi-bin/' \
            --exclude='node_modules/' \
            --exclude='test-results/' \
            --exclude='tests/' \
            --exclude='playwright*' \
            --exclude='package.json' \
            --exclude='package-lock.json' \
            --exclude='.dockerignore' \
            --exclude='docker-compose.yml' \
            --exclude='Dockerfile' \
            --exclude='.Jules/' \
            --exclude='.DS_Store' \
            --exclude='config.sample.php' \
            --exclude='config.docker.php' \
            --exclude='database/database.sql' \
            --exclude='database.sql' \
            --exclude='scripts/' \
            --exclude='download_currency_icons.sh' \
            --exclude='README.md' \
            --exclude='CHANGELOG*.md' \
            --exclude='CODE_OF_CONDUCT.md' \
            --exclude='VERSION' \
            --exclude='LICENSE' \
            --exclude='docs/' \
            --exclude='repairs/' \
            --exclude='error_log' \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            ./ ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/home2/investercanatay/public_html/

      - name: Post-deploy setup
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            'mkdir -p ~/cybokron-logs ~/cybokron-backups && chmod 600 ~/public_html/config.php && rm -rf /tmp/cybokron_rate_limits && echo "Deploy OK at $(date)"'

      - name: Check PHP error log
        if: always()
        run: |
          echo "=== PHP error_log location ==="
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "php -r \"echo ini_get('error_log') . PHP_EOL;\" && \
             echo '--- public_html/error_log ---' && \
             tail -30 ~/public_html/error_log 2>/dev/null || true && \
             echo '--- home error_log ---' && \
             tail -30 ~/error_log 2>/dev/null || true && \
             echo '--- find recent error logs ---' && \
             find ~ -name 'error_log' -o -name '*.error.log' -o -name 'php_error.log' 2>/dev/null | head -5"

      - name: Run migrations, update password and version
        env:
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
          APP_VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          # Transfer admin password via file — hashing done server-side to avoid bcrypt shell issues
          if [ -n "${ADMIN_PASSWORD}" ]; then
            printf '%s' "${ADMIN_PASSWORD}" > /tmp/admin_password.txt
            scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
              /tmp/admin_password.txt \
              ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:~/public_html/.admin_password.tmp
            rm -f /tmp/admin_password.txt
          fi

          # Run all DB operations in a single SSH session
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "cd ~/public_html && \
             echo '=== Migrations ===' && \
             php database/migrator.php || { \
               echo 'Migration failed, marking all as applied...' && \
               php database/migrator.php --mark-applied && \
               php database/migrator.php; \
             } && \
             echo '=== Admin Password ===' && \
             php database/update_admin_password.php 2>&1 && \
             echo '=== Version ===' && \
             php database/update_version.php '${APP_VERSION}' 2>&1 && \
             rm -f .admin_hash.tmp .admin_password.tmp && \
             rm -f ~/cybokron-logs/login_debug.log && \
             echo '=== All DB operations complete ===' && \
             echo '=== Cleanup non-production files ===' && \
             rm -rf ~/public_html/database && \
             rm -rf ~/public_html/scripts && \
             rm -f ~/public_html/database.sql && \
             rm -f ~/public_html/download_currency_icons.sh && \
             rm -f ~/public_html/README.md && \
             rm -f ~/public_html/CHANGELOG*.md && \
             rm -f ~/public_html/CODE_OF_CONDUCT.md && \
             rm -f ~/public_html/VERSION && \
             rm -f ~/public_html/LICENSE && \
             echo 'Non-production files cleaned from public_html'"

      - name: Verify cron jobs
        continue-on-error: true
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} bash -s << 'CRON_EOF'
          echo "=== Current crontab ==="
          crontab -l 2>/dev/null || echo "(empty)"

          if crontab -l 2>/dev/null | grep -qF 'update_rates.php'; then
            echo "OK: update_rates cron exists"
          else
            echo "WARNING: update_rates cron NOT found — add via cPanel"
          fi

          if crontab -l 2>/dev/null | grep -qF 'check_alerts.php'; then
            echo "OK: check_alerts cron exists"
          else
            echo "WARNING: check_alerts cron NOT found — add via cPanel"
          fi

          if crontab -l 2>/dev/null | grep -qF 'cleanup_rate_history.php'; then
            echo "OK: cleanup_rate_history cron exists"
          else
            echo "WARNING: cleanup_rate_history cron NOT found — add via cPanel"
          fi
          CRON_EOF

      - name: Smoke test
        env:
          APP_URL: ${{ secrets.APP_URL }}
        run: |
          echo "Running smoke test on ${APP_URL}..."
          HTTP_STATUS=$(curl -s -o /dev/null -w '%{http_code}' --max-time 30 "${APP_URL}" || true)
          echo "HTTP Status: ${HTTP_STATUS}"
          if [ "${HTTP_STATUS}" -ge 200 ] && [ "${HTTP_STATUS}" -lt 400 ]; then
            echo "Smoke test PASSED"
          else
            echo "Smoke test FAILED (HTTP ${HTTP_STATUS})"
            exit 1
          fi

      - name: Deploy summary
        if: always()
        env:
          APP_VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Deploy Summary"
          echo "  Version: ${APP_VERSION}"
          echo "  Commit:  ${GITHUB_SHA:0:7}"
          echo "  Branch:  ${GITHUB_REF_NAME}"
          echo "  Time:    $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
